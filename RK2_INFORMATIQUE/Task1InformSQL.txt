1. Создание таблиц
CREATE TABLE students (
    student_id SERIAL PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    group_number VARCHAR(20) NOT NULL
);

CREATE TABLE subjects (
    subject_id SERIAL PRIMARY KEY,
    subject_name VARCHAR(100) NOT NULL
);

CREATE TABLE grades (
    grade_id SERIAL PRIMARY KEY,
    student_id INT REFERENCES students(student_id),
    subject_id INT REFERENCES subjects(subject_id),
    grade INT CHECK (grade BETWEEN 1 AND 5)
);

CREATE TABLE attendance (
    attendance_id SERIAL PRIMARY KEY,
    student_id INT REFERENCES students(student_id),
    date_attended DATE NOT NULL,
    status VARCHAR(10) CHECK (status IN ('присутствовал', 'отсутствовал'))
);

CREATE TABLE notes (
    note_id SERIAL PRIMARY KEY,
    student_id INT REFERENCES students(student_id),
    note_text TEXT
);

2. Наполнение данных
INSERT INTO students (full_name, group_number) VALUES
('Иванов Иван Иванович', 'ГР-01'),
('Петров Петр Петрович', 'ГР-01'),
('Сидорова Анна Сергеевна', 'ГР-01'),
('Кузнецов Дмитрий Алексеевич', 'ГР-01'),
('Смирнова Екатерина Владимировна', 'ГР-01'),
('Васильев Алексей Николаевич', 'ГР-01');

INSERT INTO subjects (subject_name) VALUES
('Математический анализ'),
('Аналитическая геометрия'),
('Информатика');

INSERT INTO grades (student_id, subject_id, grade) VALUES
(1, 1, 4), (1, 2, 5), (1, 3, 5),
(2, 1, 3), (2, 2, 4), (2, 3, 3),
(3, 1, 5), (3, 2, 5), (3, 3, 5),
(4, 1, 3), (4, 2, 4), (4, 3, 4),
(5, 1, 4), (5, 2, 4), (5, 3, 5),
(6, 1, 3), (6, 2, 3), (6, 3, 4);

INSERT INTO attendance (student_id, date_attended, status) VALUES
(1, '2024-03-01', 'присутствовал'), (1, '2024-03-02', 'присутствовал'),
(2, '2024-03-01', 'присутствовал'), (2, '2024-03-02', 'отсутствовал'),
(3, '2024-03-01', 'присутствовал'), (3, '2024-03-02', 'присутствовал'),
(4, '2024-03-01', 'отсутствовал'), (4, '2024-03-02', 'присутствовал'),
(5, '2024-03-01', 'присутствовал'), (5, '2024-03-02', 'присутствовал'),
(6, '2024-03-01', 'отсутствовал'), (6, '2024-03-02', 'отсутствовал');

INSERT INTO notes (student_id, note_text) VALUES
(1, 'Любит информатику'),
(2, 'Нужна помощь по информатике'),
(3, 'Отличник по всем предметам'),
(4, 'Редко посещает занятия по информатике'),
(5, 'Хорошо работает в команде'),
(6, 'Прогресс по информатике');

3. Индексы
CREATE INDEX idx_students_group ON students(group_number);
CREATE INDEX idx_grades_student ON grades(student_id);
CREATE INDEX idx_notes_text ON notes USING GIN(to_tsvector('russian', note_text));

4. Представления
CREATE VIEW student_avg_grades AS
SELECT s.student_id, s.full_name, ROUND(AVG(g.grade), 2) as avg_grade
FROM students s
JOIN grades g ON s.student_id = g.student_id
GROUP BY s.student_id, s.full_name;

5. Транзакция (добавление нового студента с оценками)
BEGIN;
INSERT INTO students (full_name, group_number) VALUES ('Новиков Сергей Викторович', 'ГР-01');
WITH new_student AS (SELECT currval('students_student_id_seq') as new_id)
INSERT INTO grades (student_id, subject_id, grade)
SELECT new_id, subject_id, 4 FROM new_student, subjects;
COMMIT;

6. Запросы

А) Найти 5 одногруппников студента (2 до и 3 после него по списку student_id)
SELECT full_name FROM students 
WHERE group_number = 'ГР-01' 
AND student_id BETWEEN (SELECT student_id - 2 FROM students WHERE full_name = 'Иванов Иван Иванович')
                   AND (SELECT student_id + 3 FROM students WHERE full_name = 'Иванов Иван Иванович')
ORDER BY student_id;

Б) Посмотреть средний балл конкретного студента через представление
SELECT * FROM student_avg_grades WHERE full_name = 'Иванов Иван Иванович';

В) Агрегировать средний балл по предмету «Информатика»
SELECT ROUND(AVG(g.grade), 2) as avg_informatics
FROM grades g
JOIN subjects s ON g.subject_id = s.subject_id
WHERE s.subject_name = 'Информатика';

Г) Выполнить полнотекстовый поиск по заметкам, например, найти заметки, содержащие слово «Информатика»
SELECT n.note_id, s.full_name, n.note_text
FROM notes n
JOIN students s ON n.student_id = s.student_id
WHERE to_tsvector('russian', n.note_text) @@ to_tsquery('russian', 'Информатика');

Д) Обновить посещаемость студента на конкретную дату через транзакцию
BEGIN;
UPDATE attendance SET status = 'присутствовал' 
WHERE student_id = (SELECT student_id FROM students WHERE full_name = 'Васильев Алексей Николаевич')
AND date_attended = '2024-03-01';
COMMIT;